<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const CLIENT_ID = '145337605718-efhjjeqlrousk987od6nguchijma20uu.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDDlKALwWGlhVvwaOOP7hVxUlp9xeAPg2k';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest';
        const SCOPES = 'https://www.googleapis.com/auth/tasks.readonly';

        function App() {
            const [tokenClient, setTokenClient] = React.useState();
            const [gapiInited, setGapiInited] = React.useState(false);
            const [gisInited, setGisInited] = React.useState(false);

            const [taskLists, setTaskLists] = React.useState([]);
            const gapiLoaded = () => {
                const initializeGapiClient = async () => {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: [DISCOVERY_DOC],
                    });
                    setGapiInited(true);
                };
                
                gapi.load('client', initializeGapiClient);
            };

            const gisLoaded = () => {
                let tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                setGisInited(true);
                setTokenClient(tokenClient);
            };

            React.useEffect(() => {
                gapiLoaded()
                gisLoaded()
            }, []);

            const handleAuth = () => {
                if (!gapi || !tokenClient) return;
                
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    tokenClient.requestAccessToken({ prompt: '' });
                }

                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    await fetchTaskLists();
                };
            };

            const fetchTaskLists = async () => {
                let response;
                try {
                    response = await gapi.client.tasks.tasklists.list({ 'maxResults': 10 });
                    setTaskLists(response.result.items)
                } catch (err) {
                    document.getElementById('content').innerText = err.message;
                    return;
                }
            };

            return (
                <div>
                    <h1>Welcome to My TODO App</h1>
                    <p>This is a simple embedded React application.</p>
                    <button onClick={handleAuth}>Authorize</button>
                    <button onClick={fetchTaskLists}>Fetch Task Lists</button>

                    { taskLists.map(item => {
                        return <>{item.title}</>
                    })
                </div>
            );
        }

        // Render the App component into the root div
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
